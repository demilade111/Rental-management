generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
// ========== PROPERTY & LEASE ENUMS ==========
enum PropertyType {
  APARTMENT
  CONDO
  TOWNHOUSE
  MULTI_FAMILY
  SINGLE_FAMILY
  STUDIO
  INDUSTRIAL
  OFFICE
  RETAIL
  SHOPPING_CENTER
  STORAGE
  PARKING_SPACE
  WAREHOUSE
}

enum PropertyCategory {
  RESIDENTIAL
  COMMERCIAL
}

enum ResidentialType {
  APARTMENT
  CONDO
  TOWNHOUSE
  MULTI_FAMILY
  SINGLE_FAMILY
  STUDIO
}

enum CommercialType {
  INDUSTRIAL
  OFFICE
  RETAIL
  SHOPPING_CENTER
  STORAGE
  PARKING_SPACE
  WAREHOUSE
}

enum RentCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum LeaseStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
}

enum LeaseTermType {
  LONG_TERM
  MONTH_TO_MONTH
  YEAR_TO_YEAR
}

enum NoticeType {
  LEGAL_MINIMUM
  MORE_THAN_MINIMUM
}

enum DepositNoticeType {
  LEGAL_MAXIMUM
  LESS_THAN_MINIMUM
}

enum LandlordType {
  INDIVIDUAL
  CORPORATION
}

// ========== USER & ROLES ==========
enum UserRole {
  ADMIN
  TENANT
}

// ========== MAINTENANCE ==========
enum MaintenanceStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MaintenancePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MaintenanceCategory {
  PLUMBING
  ELECTRICAL
  HVAC
  APPLIANCE
  STRUCTURAL
  PEST_CONTROL
  CLEANING
  LANDSCAPING
  SECURITY
  OTHER
}

enum ApplicationStatus {
  NEW
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LeaseType {
  STANDARD
  CUSTOM
}

enum ListingStatus {
  ACTIVE
  RENTED
}

// ========== PAYMENT ==========
enum PaymentType {
  RENT
  DEPOSIT
  REFUND
  OTHER
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}
model CustomLease {
  id         String  @id @default(cuid())
  listingId  String?
  landlordId String
  tenantId   String?

  leaseName    String
  description  String?
  propertyType String?
  fileUrl      String

  leaseStatus LeaseStatus @default(DRAFT)

  // Accounting fields (manually entered from handwritten contract)
  startDate        DateTime?
  endDate          DateTime?
  rentAmount       Float?
  paymentFrequency RentCycle?
  securityDeposit  Float?
  depositAmount    Float?
  paymentDay       Int?        // Due day (1-31)
  paymentMethod    String?
  
  // Additional accounting metadata
  accountingNotes  String?      // Any notes about accounting from the contract

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  maintenanceRequests MaintenanceRequest[]
  payments            Payment[]

  // Relations
  listing  Listing? @relation(fields: [listingId], references: [id])
  tenant   User?    @relation("TenantCustomLeases", fields: [tenantId], references: [id])
  landlord User     @relation("LandlordCustomLeases", fields: [landlordId], references: [id])

  @@index([listingId])
  @@index([landlordId])
}
model Lease {
  id               String      @id @default(cuid())
  listingId        String
  tenantId         String
  landlordId       String
  startDate        DateTime
  endDate          DateTime
  rentAmount       Float
  paymentFrequency RentCycle
  securityDeposit  Float?
  paymentMethod    String?
  leaseStatus      LeaseStatus @default(DRAFT)
  leaseDocument    String?
  signedContract   String?
  notes            String?

  propertyCategory PropertyCategory?
  residentialType  ResidentialType?
  commercialType   CommercialType?
  propertyAddress  String?
  propertyCity     String?
  propertyState    String?
  propertyCountry  String?
  propertyZipCode  String?

  leaseTermType LeaseTermType?

  paymentDay Int? // due day (1â€“31)

  acceptsCash        Boolean @default(false)
  acceptsCheque      Boolean @default(false)
  acceptsDirectDebit Boolean @default(false)
  acceptsETransfer   Boolean @default(false)
  acceptsOther       Boolean @default(false)
  customPaymentInfo  String?

  rentIncreaseNoticeType       NoticeType?
  customRentIncreaseNoticeDays Int?

  hasSecurityDeposit      Boolean            @default(false)
  discloseBankInfo        Boolean            @default(false)
  depositAmount           Float?
  depositBankName         String?
  depositAccountInfo      String?
  depositReturnNoticeType DepositNoticeType?
  customDepositNoticeDays Int?

  landlordType        LandlordType?
  landlordFullName    String?
  landlordEmail       String?
  landlordPhone       String?
  landlordAddress     String?
  additionalLandlords Json?

  tenantFullName    String?
  tenantEmail       String?
  tenantPhone       String?
  additionalTenants Json?

  allowsOccupants   Boolean @default(false)
  occupants         Json?
  numberOfOccupants Int?

  listing             Listing              @relation(fields: [listingId], references: [id])
  tenant              User                 @relation("TenantLeases", fields: [tenantId], references: [id])
  landlord            User                 @relation("LandlordLeases", fields: [landlordId], references: [id])
  maintenanceRequests MaintenanceRequest[]
  applications        RequestApplication[]
  payments            Payment[]

  @@index([tenantId])
  @@index([landlordId])
}
model LeaseInvite {
  id        String    @id @default(cuid())
  leaseId   String
  leaseType LeaseType // enum: STANDARD | CUSTOM
  tenantId  String?
  token     String    @unique
  url       String
  expiresAt DateTime
  createdAt DateTime  @default(now())
  signed    Boolean   @default(false)
}
model Listing {
  id         String @id @default(cuid())
  landlordId String

  // Property Details Section
  title           String
  propertyType    PropertyType
  propertyOwner   String?
  bedrooms        Int?
  bathrooms       Int?
  totalSquareFeet Int?
  yearBuilt       Int?

  // Address Section
  country       String
  state         String
  city          String
  streetAddress String
  zipCode       String?

  // Rental Information Section
  rentCycle           RentCycle
  rentAmount          Float
  securityDeposit     Float?
  petDeposit          Float?
  availableDate       DateTime
  status              ListingStatus        @default(ACTIVE)
  description         String?
  contactName         String?
  phoneNumber         String?
  email               String?
  notes               String?
  landlord            User                 @relation("LandlordListings", fields: [landlordId], references: [id], onDelete: Cascade)
  amenities           ListingAmenity[]
  images              ListingImage[]
  leases              Lease[]
  maintenanceRequests MaintenanceRequest[]
  applications        RequestApplication[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  customLeases CustomLease[]

  @@index([landlordId])
  @@index([city, propertyType])
  @@index([rentCycle])
  @@index([availableDate])
}

model ListingAmenity {
  id        String @id @default(cuid())
  listingId String
  name      String

  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([listingId, name])
  @@index([listingId])
}

model ListingImage {
  id        String   @id @default(cuid())
  listingId String
  url       String
  isPrimary Boolean  @default(false)
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([listingId, url])
  @@index([listingId])
}
model MaintenanceRequest {
  id            String               @id @default(cuid())
  listingId     String
  userId        String
  description   String
  status        MaintenanceStatus    @default(OPEN)
  priority      MaintenancePriority  @default(MEDIUM)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  leaseId       String?
  customLeaseId String?
  category      MaintenanceCategory
  title         String
  images        MaintenanceImage[]
  messages      MaintenanceMessage[]
  lease         Lease?               @relation(fields: [leaseId], references: [id])
  customLease   CustomLease?         @relation(fields: [customLeaseId], references: [id])
  listing       Listing              @relation(fields: [listingId], references: [id])
  user          User                 @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([listingId, createdAt])
  @@index([status, priority, createdAt])
  @@index([category])
  @@index([createdAt])
}

model MaintenanceImage {
  id                   String             @id @default(cuid())
  maintenanceRequestId String
  url                  String
  createdAt            DateTime           @default(now())
  maintenanceRequest   MaintenanceRequest @relation(fields: [maintenanceRequestId], references: [id], onDelete: Cascade)

  @@index([maintenanceRequestId])
}

model MaintenanceMessage {
  id                   String             @id @default(cuid())
  maintenanceRequestId String
  senderId             String
  body                 String
  createdAt            DateTime           @default(now())
  maintenanceRequest   MaintenanceRequest @relation(fields: [maintenanceRequestId], references: [id], onDelete: Cascade)
  sender               User               @relation(fields: [senderId], references: [id])

  @@index([maintenanceRequestId])
  @@index([senderId])
}
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  isRead    Boolean          @default(false)
  readAt    DateTime?
  relatedId String? // ID of related entity (e.g., maintenance request ID)
  metadata  Json? // Store additional data like listing info, unread count, etc.
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@index([userId, createdAt])
  @@index([type, createdAt])
  @@index([isRead])
}

enum NotificationType {
  MAINTENANCE_REQUEST
  MAINTENANCE_MESSAGE
  // Future types can be added here:
  // APPLICATION_STATUS
  // LEASE_EXPIRING
  // PAYMENT_DUE
}

// Payment model for tracking rent and deposit payments
// Works with both Lease and CustomLease

model Payment {
  id            String        @id @default(cuid())
  leaseId       String?       // For standard leases
  customLeaseId String?       // For custom leases
  landlordId    String
  tenantId      String?
  
  type          PaymentType
  amount        Float
  status        PaymentStatus @default(PENDING)
  dueDate       DateTime?
  paidDate      DateTime?
  
  paymentMethod String?       // e.g., "Cash", "Check", "Bank Transfer", "e-Transfer"
  reference     String?       // Transaction reference, check number, etc.
  notes         String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  lease         Lease?        @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  customLease   CustomLease?  @relation(fields: [customLeaseId], references: [id], onDelete: Cascade)
  landlord      User          @relation("LandlordPayments", fields: [landlordId], references: [id])
  tenant        User?         @relation("TenantPayments", fields: [tenantId], references: [id])

  @@index([leaseId])
  @@index([customLeaseId])
  @@index([landlordId])
  @@index([tenantId])
  @@index([dueDate])
  @@index([status])
}

model RequestApplication {
  id             String            @id @default(cuid())
  publicId       String            @unique
  listingId      String
  tenantId       String?
  landlordId     String
  fullName       String?
  email          String?
  phone          String?
  dateOfBirth    DateTime?
  monthlyIncome  Float?
  currentAddress String?
  moveInDate     DateTime?
  occupants      Json?
  pets           Json?
  documents      Json?
  references     Json?
  message        String? // store requirements of the contact as json data
  status         ApplicationStatus @default(PENDING)
  reviewedBy     String?
  reviewedAt     DateTime?
  decisionNotes  String?
  leaseId        String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  expirationDate DateTime?
  listing        Listing           @relation(fields: [listingId], references: [id], onDelete: Cascade)
  landlord       User              @relation("LandlordApplications", fields: [landlordId], references: [id])
  tenant         User?             @relation("TenantApplications", fields: [tenantId], references: [id])
  lease          Lease?            @relation(fields: [leaseId], references: [id])
  employmentInfo EmploymentInfo[]

  @@index([listingId])
  @@index([landlordId])
  @@index([tenantId])
  @@index([publicId])
  @@index([status])
}

model EmploymentInfo {
  id            String             @id @default(cuid())
  applicationId String
  employerName  String
  jobTitle      String
  income        Float?
  duration      String?
  address       String?
  proofDocument String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  application   RequestApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}
model User {
  id               String    @id @default(cuid())
  email            String    @unique
  password         String
  firstName        String?
  lastName         String?
  phone            String?
  role             UserRole  @default(TENANT)
  profileImage     String?
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Existing relations
  landlordLeases       Lease[]              @relation("LandlordLeases")
  tenantLeases         Lease[]              @relation("TenantLeases")
  tenantCustomLeases   CustomLease[]        @relation("TenantCustomLeases")
  landlordCustomLeases CustomLease[]        @relation("LandlordCustomLeases")
  landlordPayments     Payment[]            @relation("LandlordPayments")
  tenantPayments       Payment[]            @relation("TenantPayments")
  listings             Listing[]            @relation("LandlordListings")
  maintenanceRequests  MaintenanceRequest[]
  landlordApplications RequestApplication[] @relation("LandlordApplications")
  tenantApplications   RequestApplication[] @relation("TenantApplications")
  MaintenanceMessage   MaintenanceMessage[]
  notifications        Notification[]       @relation("UserNotifications")

  @@map("users")
}
